function app_refresh_page_banner(obj_banner,data){if(data){obj_banner.find(".banner_url").attr("href",data.URL);obj_banner.find(".banner_img").attr("src",data.IMG);if(data.TEXT)obj_banner.find(".banner_info").html(data.TEXT).show();else obj_banner.find(".banner_info").hide();if(data.EXTRATEXT)obj_banner.find(".banner_extra").html(data.EXTRATEXT).show();else obj_banner.find(".banner_extra").hide();obj_banner.find(".banner_img").css("height",data.HEIGHT=="0"||!data.HEIGHT?"auto":data.HEIGHT+"px");obj_banner.show()}else{obj_banner.hide()}}function on_appmsg_comment_newlist(message){js_app_send({command:"message",dest_view_name:"foot",message:"lightdot",which:"user",number:"0"});$("#u_mine .dotip").hide();$("#u_diary .dotip:visible,#u_works .dotip:visible,#u_honour .dotip:visible,#u_wrong .dotip:visible,#u_report .dotip:visible").hide()}function app_refresh_flag_by_data(data){g_share_watermark=data.share_watermark?data.share_watermark:"";if(data.newest)for(var i=0;i<data.newest.length;i++)$("#"+data.newest[i]+" .dotip").hide();if(data.updated)for(var i=0;i<data.updated.length;i++){$("#"+data.updated[i]+" .dotip").show();if(data.updated[i]=="u_mine"){js_app_send({command:"message",dest_view_name:"foot",message:"lightdot",which:"user",number:"1"});if(g_app_version>=20100)js_app_send({command:"notify",msgid:1,title:"纳米盒动态消息提示",subtitle:"点击查看盒粉对你消息的最新回复",soundflag:1,always_tone:0,limit:3,icon:"",url:g_site+"/diary/mine_new"});if(typeof mine_has_monitored!="undefined")mine_has_monitored=true}else if(data.updated[i]=="i_diary"||data.updated[i]=="i_works"||data.updated[i]=="i_honour"){js_app_send({command:"message",dest_view_name:"foot",message:"lightdot",which:"world",number:"1"});if(typeof world_has_monitored!="undefined")world_has_monitored=true}}}function app_refresh_page_by_data(data){app_refresh_page_save(data);if(data.banner)app_refresh_page_banner($(".banner"),data.banner);if(data.sections){for(var idx=0;idx<data.sections.length;idx++){var section=data.sections[idx];if(!section.ID)continue;var dom_sec=$("#SEC_"+section.ID+"_LIST");if(dom_sec.length!=1)continue;for(var item_idx=0;item_idx<section.ITEMS.length;item_idx++){var item=section.ITEMS[item_idx];if(!item.ID)continue;var dom_item_foot=dom_sec.find("#"+item.ID+" .nbfoot");if(dom_item_foot.length!=1)continue;for(var sup_idx=0;sup_idx<section.SUPPORT.length;sup_idx++){var support=section.SUPPORT[sup_idx];if(support=="PRAISE"&&dom_item_foot.find(".praisecount").length==1){dom_item_foot.find(".praisecount").html(item.PRAISECOUNT+"&nbsp;赞")}else if(support=="COMMENT"&&dom_item_foot.find(".commentcount").length==1){dom_item_foot.find(".commentcount").html(item.COMMENTCOUNT+"&nbsp;评")}else if(support=="READ"&&dom_item_foot.find(".readcount").length==1){dom_item_foot.find(".readcount").html(item.READCOUNT+"&nbsp;阅")}else if(support=="CUSTOMER"&&dom_item_foot.find(".customer").length==1){dom_item_foot.find(".customer").html(item.CUSTOMER)}else if(support=="AUDIO"&&dom_item_foot.find(".audio").length==1){dom_item_foot.find(".audio").html(item.AUDIO)}}}}}}function app_refresh_page_monitor(){if(typeof monitor_interval_tick=="undefined"||typeof monitor_interval=="undefined")return;monitor_interval_tick+=1e3;if(monitor_interval_tick>monitor_interval+30*1e3){app_refresh_page()}}function app_refresh_page(){var data_user={};var count_update_flag=0;if(typeof monitor_interval_tick!="undefined")monitor_interval_tick=0;if(typeof g_do_app_refresh_page!="undefined"&&!g_do_app_refresh_page){if(typeof monitor_interval!="undefined")window.setTimeout(app_refresh_page,monitor_interval);return}if(typeof monitor_list!="undefined"){for(var index=0;index<monitor_list.length;index++){if(monitor_list[index]==null)continue;var id_dom_cur=monitor_list[index][0];var display_dot=$("#"+id_dom_cur+" .dotip").css("display");if(display_dot=="none"||typeof world_has_monitored!="undefined"&&!world_has_monitored&&(id_dom_cur=="i_diary"||id_dom_cur=="i_works"||id_dom_cur=="i_honour")||typeof mine_has_monitored!="undefined"&&!mine_has_monitored&&id_dom_cur=="u_mine"){data_user[(monitor_list[index][2]=="public"?"up_":"uu_")+monitor_list[index][1]]=id_dom_cur;count_update_flag+=1}}}if(typeof rate_interval_of_page_refresh!="undefined"&&rate_interval_of_page_refresh>0){data_user["refreshtick"]=rate_interval_of_page_refresh_tick;data_user["refreshval"]=rate_interval_of_page_refresh;rate_interval_of_page_refresh_tick+=1;if(rate_interval_of_page_refresh_tick<=rate_interval_of_page_refresh){if(!count_update_flag){if(typeof monitor_interval!="undefined")window.setTimeout(app_refresh_page,monitor_interval);return}}else{rate_interval_of_page_refresh_tick=1}}else if(typeof monitor_list!="undefined"&&!count_update_flag){if(typeof monitor_interval!="undefined")window.setTimeout(app_refresh_page,monitor_interval);return}data_user["appmirror"]=g_app_mirror;if(typeof g_app_url_refresh!="undefined")var url=g_site+"/app/refresh_page?url="+g_app_url_refresh;else var url=g_site+g_cur_url+(g_cur_url.indexOf("?")>0?"&":"?")+"amrefresh=1";if(typeof g_app_extend!="undefined")jQuery.extend(data_user,g_app_extend);$(".mirrorun").show();$.ajax({url:url,type:"GET",data:data_user,dataType:g_jquery_dtype,timeout:1e4,error:function(){$(".mirrorun").hide();if(typeof monitor_interval_tick!="undefined")monitor_interval_tick=0;if(typeof monitor_interval!="undefined")window.setTimeout(app_refresh_page,monitor_interval)},success:function(data){$(".mirrorun").hide();if(typeof monitor_interval_tick!="undefined")monitor_interval_tick=0;if(typeof app_refresh_flag_by_data_ex=="function")app_refresh_flag_by_data_ex(data);else app_refresh_flag_by_data(data);if(typeof app_refresh_page_by_data_ex=="function")app_refresh_page_by_data_ex(data);else app_refresh_page_by_data(data);if(!data.stop_update&&typeof monitor_interval!="undefined")window.setTimeout(app_refresh_page,monitor_interval)}})}function app_icon_click(){obj_this=$(this);obj_this.find(".dotip").hide();var id_parent=obj_this.parent().attr("id");if(id_parent=="i_diary"||id_parent=="i_works"||id_parent=="i_honour"){if($("#i_diary .dotip").css("display")=="none"&&$("#i_works .dotip").css("display")=="none"&&$("#i_honour .dotip").css("display")=="none")js_app_send({command:"message",dest_view_name:"foot",message:"lightdot",which:"world",number:"0"})}var id_parent=obj_this.parent().attr("id");if(id_parent=="u_mine"){on_appmsg_comment_newlist(null)}}function on_app_page_resize_for_mirrorver(){if(!$("#mirrorver").length){$("<div>").attr("id","mirrorver").addClass("mirrorver").html(g_app_mirror_ver).appendTo($("body"))}$("#mirrorver").hide();var height_body=$(document.body).height();var height_window=$(window).height();if(true||height_body>height_window){$("#mirrorver").css("display","block").show()}else{$("#mirrorver").css("position","absolute").css("right","0px").css("top",height_window-$("#mirrorver").height()+"px").show()}}$(function(){if(typeof g_app_mirror!="undefined"&&g_app_mirror){if(g_app_mirror_ver){$(window).resize(on_app_page_resize_for_mirrorver);on_app_page_resize_for_mirrorver()}$("<img>").attr("src",g_cdn+"/tina/static/loader.gif").addClass("mirrorun").appendTo($("body"));$("a").each(function(){if($(this).attr("href")&&!$(this).attr("href").startWith("http://")){$(this).attr("href",g_site+$(this).attr("href"))}});$("form").each(function(){if($(this).attr("action")&&!$(this).attr("action").startWith("http://")){$(this).attr("action",g_site+$(this).attr("action"))}});window.setTimeout(app_refresh_page,500)}});function app_refresh_page_restore(){if(g_app_mirror&&g_app_version>2e4){var key_page="pagecache_"+g_cur_url.split("?")[0];var dict_data={};dict_data[key_page]="";js_app_send({command:"query_user_config",maps:dict_data},function(response){if(response[key_page]){var data_cache=$.parseJSON(response[key_page]);if(typeof g_refresh_page_called=="undefined"||!g_refresh_page_called){data_cache.restore=true;if(typeof app_refresh_page_by_data_ex=="function")app_refresh_page_by_data_ex(data_cache);else app_refresh_page_by_data(data_cache)}}})}}function app_refresh_page_save(data){g_refresh_page_called=true;if(g_app_mirror&&g_app_version>2e4&&!data.restore){var key_page="pagecache_"+g_cur_url.split("?")[0];var dict_data={};dict_data[key_page]=$.toJSON(data);js_app_send({command:"user_config",maps:dict_data})}}function namibox_app_ready(){app_refresh_page_restore()}