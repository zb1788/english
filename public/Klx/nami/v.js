function v_content_max_clinet_content(){win_size=window.getWinSize();max_height=win_size[1]-$("#bookcontent").offset().top-3;$("#bookcontent").css("height",max_height+"px").css("line-height",max_height+"px");$("#pplayer").css("left","5px").css("top",win_size[1]-48-5+"px");$(".mp3").css("left","5px").css("top",win_size[1]-48-5+"px");v_content_on_image_load()}function v_content_on_image_load(){con_width=$("#bookcontent").width();con_height=$("#bookcontent").height();bcoffset=$("#bookcontent").offset();img_width=imglist[cur_page-1][2];img_height=imglist[cur_page-1][3];if(!g_ismobile||con_width<con_height&&img_width<img_height||con_width>con_height&&img_width>img_height){if(con_width*img_height>con_height*img_width){img_width_new=con_height*img_width/img_height;img_height_new=con_height}else{img_width_new=con_width;img_height_new=con_width*img_height/img_width}$("#bookimg").rotate(0);$("#book_prev").rotate(180);$("#book_prev").css("top",bcoffset.top+(con_height-nav_pic_width)/2+"px");$("#book_prev").css("left",bcoffset.left+10+"px");$("#book_next").rotate(0);$("#pauplayer").rotate(0);$("#recycle").rotate(0);$("#book_next").css("top",bcoffset.top+(con_height-nav_pic_width)/2+"px");$("#book_next").css("left",bcoffset.left+con_width-nav_pic_width-10+"px")}else{if(con_width*img_width>con_height*img_height){img_width_new=con_height;img_height_new=con_height*img_height/img_width}else{img_width_new=con_width*img_width/img_height;img_height_new=con_width}if(con_width<con_height&&img_width>img_height){$("#bookimg").rotate(90);$(".thumb_author").rotate(90);$("#book_prev").rotate(270);$("#book_prev").css("top",bcoffset.top+10+"px");$("#book_prev").css("left",bcoffset.left+(con_width-nav_pic_width)/2+"px");$("#book_next").rotate(90);$("#pauplayer").rotate(90);$("#recycle").rotate(90);$("#book_next").css("top",bcoffset.top+con_height-nav_pic_width+"px");$("#book_next").css("left",bcoffset.left+(con_width-nav_pic_width)/2+"px")}else{$("#bookimg").rotate(270);$(".thumb_author").rotate(270);$("#book_next").rotate(270);$("#pauplayer").rotate(270);$("#recycle").rotate(270);$("#book_next").css("top",bcoffset.top+10+"px");$("#book_next").css("left",bcoffset.left+(con_width-nav_pic_width)/2+"px");$("#book_prev").rotate(90);$("#book_prev").css("top",bcoffset.top+con_height-nav_pic_width+"px");$("#book_prev").css("left",bcoffset.left+(con_width-nav_pic_width)/2+"px")}}$("#bookimg").css("position","absolute");$("#bookimg").css("width",img_width_new+"px").css("height",img_height_new+"px");$("#bookimg").css("max-width",img_width_new+"px").css("max-height",img_height_new+"px");$("#bookimg").css("top",bcoffset.top+(con_height-img_height_new)/2+"px");$("#bookimg").css("left",bcoffset.left+(con_width-img_width_new)/2+"px")}function v_content_show_page(page){page=Math.max(page,1);page=Math.min(page,imglist.length);$("#bookimg").attr({src:g_cdn+"/tina/static/d/"+url_content+"/"+imglist[page-1][0]});$("#toptitle").html(book_name+"("+page+"/"+imglist.length+")");cur_page=page;urlaudio=encodeURI(urlaudio_base+imglist[page-1][1]);if(imglist[page-1][1]&&allow_voice&&!js_app_send({command:"playaudio",url:urlaudio,mode:"simple",tipname:book_name,index:cur_page,recache:false,duration:imglist[page-1][4]})){if(g_support_html5){$("#pplayer").show();audio_player.pause();audio_player.src=urlaudio;audio_player.play()}else{$(".mp3").children().remove();$(".mp3").jmp3({filepath:urlaudio,width:$(".mp3").width(),backcolor:"ffd700",forecolor:"8B4513"});$(".mp3").show()}}else{$("#pplayer").hide();$(".mp3").hide()}cur_page<=1?$("#book_prev").hide():$("#book_prev").show();cur_page>=imglist.length?$("#book_next").hide():$("#book_next").show();if(cur_page>=imglist.length){win_size=window.getWinSize();$("#docomment").show();$("#docomment").css("opacity","0.9").css("left",(win_size[0]-$("#docomment").width())/2+"px").css("top",(win_size[1]-$("#docomment").height())/2+"px")}if(cur_page<imglist.length)$("#bookimg_hide").attr({src:g_cdn+"/tina/static/d/"+url_content+"/"+imglist[cur_page][0]})}function v_content_start_reading(){$("#book_next").css({opacity:.6});$("#book_prev").css({opacity:.6});$("#book_prev").click(function(){v_content_show_page(cur_page-1);return false});$("#book_next").click(function(){v_content_show_page(cur_page+1);return false});$("#nbhead_right").click(function(){$("#nbhead_right_inner").html(allow_voice?"静音":"配音");allow_voice=!allow_voice;v_content_show_page(cur_page)});$("#bookimg").click(function(){$("#book_next").click();event.stopPropagation()});$("#auplayer").bind("play",function(){$("#pauplayer")[0].src=g_cdn+"/tina/static/audio/pause3.png";$("#pauplayer")[0].status="pause"});$("#auplayer").bind("pause",function(){$("#pauplayer")[0].src=g_cdn+"/tina/static/audio/play3.png";$("#pauplayer")[0].status="play"});$("#auplayer").bind("ended",function(){$("#pauplayer")[0].src=g_cdn+"/tina/static/audio/play3.png";$("#pauplayer")[0].status="play"});$("#pauplayer").click(function(){if(this.status=="play"){audio_player.src=audio_player.src;audio_player.play()}else audio_player.pause()});$("#rrecycle").click(function(){if(auto_flag){$("#recycle")[0].src=g_cdn+"/tina/static/audio/unauto.png";auto_flag=false}else{$("#recycle")[0].src=g_cdn+"/tina/static/audio/auto.png";auto_flag=true}});v_content_show_page(1)}function v_content_main(){if(g_user_agent.indexOf("msie")<0){$(window).resize(function(){v_content_max_clinet_content()})}else{$.fn.extend({rotate:function(a){}})}audio_player=$("#auplayer")[0];v_content_max_clinet_content();$("#bookimg").load(v_content_on_image_load);$("#bookimg").attr({src:g_cdn+"/tina/static/d/"+url_content+"/"+imglist[0][0]});if(b_has_voice){$("#nbhead_right").show();$("#rrecycle").show();if(g_ismobile&&g_browser!="app"){$("#voicetip").css("top",(window.getWinSize()[1]-$("#voicetip").height())/2-20+"px");$("#voicetip").show();$("#voicetipbtn").click(function(){$("#voicetip").hide();v_content_start_reading()})}else{setTimeout(function(){v_content_start_reading()},1e3)}}else{$("#nbhead_right").hide();$("#rrecycle").hide();v_content_start_reading()}$("#auplayer").bind("ended",function(){if(auto_flag){auto_next_page()}});window.onbeforeunload=function(){if(g_app_version>10004)js_app_send({command:"playoperate",playstatus:"stop",mode:"simple"})}}function v_audio_init_player(b_show_player){$(player_used).css("opacity","0.85");size_win=window.getWinSize();height_player=$(player_used).height();$(player_used).css("top",size_win[1]-height_player+"px");$("#body_inner").css("padding-bottom",10+height_player+"px");if(b_show_player){if($(player_used).css("display")=="none"){$(player_used).fadeIn(800)}}}function v_audio_track_playing_begin(){b_begin_time=new Date;b_cur_playing=audio_player.src}function v_audio_track_playing_end(force_commit,async_flag){if(b_begin_time){b_seg_sum+=new Date-b_begin_time;b_begin_time=null}if(force_commit&&b_cur_playing&&b_seg_sum>0){if(b_report_playstat){$.ajax({type:"GET",url:"/playstat?url="+b_cur_playing+"&time="+b_seg_sum,cache:false,async:async_flag})}b_seg_sum=0;b_begin_time=null}}function v_audio_main(){player_used=g_support_html5?"#player":"#player_ie";v_audio_init_player(false);audio_player=$("#auplayer")[0];$(".audioitem").bind("click",function(){b_click_repeat=$(this).hasClass("audioitem_focus");$(".audioitem_focus").removeClass("audioitem_focus");$(this).addClass("audioitem_focus");tiptitle=$(this).attr("tiptitle");$("#tiptile").html(tiptitle);urlaudio=encodeURI(g_cdn_audio+"/tina/static/d/"+url_content+"/"+$(this).attr("filename"));if(js_app_send({command:"playaudio",url:urlaudio,mode:"full",tipname:tiptitle,index:$(this).attr("l0"),recache:false,duration:$(this).attr("duration")})){$(player_used).hide();if(b_report_playstat){$.ajax({type:"GET",url:"/playstat?url="+urlaudio+"&time="+29876,cache:false,async:true})}return}v_audio_init_player(true);if(b_click_repeat)return;if(g_support_html5){audio_player.pause();audio_player.src=urlaudio;v_audio_track_playing_end(true,true);audio_player.play()}else{$(".mp3").children().remove();$(".mp3").jmp3({filepath:urlaudio,width:$(".mp3").width(),backcolor:"ffd700",forecolor:"8B4513"})}});$("#auplayer").bind("durationchange",function(){$("#duration").html(fmt_time(audio_player.duration))});$("#auplayer").bind("timeupdate",function(){$("#curpos").html(fmt_time(audio_player.currentTime));posbar=$("#posbar").parent().width()*audio_player.currentTime/audio_player.duration;$("#posbar").css("width",posbar+"px");$("#posblock").css("left",posbar-$("#posblock").width()/2+"px")});$("#playstatus").bind(clickevent,function(){if(audio_player.paused)audio_player.play();else audio_player.pause()});$("#clickbar").bind(clickevent,function(e){if(clickevent=="touchstart")offsetX=e.originalEvent.targetTouches[0].pageX-10;else offsetX=e.offsetX;if(audio_player.played){new_pos=offsetX*audio_player.duration/$("#progressbar").width();if(new_pos>audio_player.duration)new_pos=audio_player.duration;audio_player.currentTime=new_pos;if(audio_player.paused)audio_player.play()}});$("#auplayer").bind("play",function(){v_audio_track_playing_begin();$("#playstatus")[0].src=g_cdn+"/tina/static/audio/pause2.png"});$("#auplayer").bind("pause",function(){v_audio_track_playing_end(false,true);$("#playstatus")[0].src=g_cdn+"/tina/static/audio/play2.png"});$("#auplayer").bind("ended",function(){v_audio_track_playing_end(false,true);$("#playstatus")[0].src=g_cdn+"/tina/static/audio/play2.png";playmode=$('input[name="playmode"]:checked').val();if(playmode=="autorepeat"){audio_player.currentTime=0;audio_player.play()}else if(playmode=="autocontinue"){$("#playnext").trigger(clickevent)}});$("#playprev").bind(clickevent,function(e){cur_index=$(".audioitem_focus").attr("l0");if(cur_index){$("#fp_"+(parseInt(cur_index)-1)).click()}});$("#playnext").bind(clickevent,function(e){cur_index=$(".audioitem_focus").attr("l0");if(cur_index){$("#fp_"+(parseInt(cur_index)+1)).click()}});window.onbeforeunload=function(){v_audio_track_playing_end(true,false)};if(navigator.userAgent.indexOf("MSIE ")<0){$(window).resize(function(){v_audio_init_player()})}}function on_appcmd_playcontrol(message){req_index=parseInt(message.index);cur_index=req_index+(message.direction=="forward"?1:-1);next_obj=$(".audioitem[l0="+cur_index+"]");if(next_obj.length){$(".audioitem_focus").removeClass("audioitem_focus");next_obj.addClass("audioitem_focus")}else{next_obj=$(".audioitem[l0="+req_index+"]");cur_index=req_index}urlaudio=encodeURI(g_cdn+"/tina/static/d/"+url_content+"/"+next_obj.attr("filename"));return{index:cur_index,url:urlaudio,tipname:next_obj.attr("tiptitle"),duration:next_obj.attr("duration"),mode:"full"}}function hanzi_html5_animate(html_obj_id,hzframe,hzfill,size_box){canvas=document.getElementById(html_obj_id);var ctx=canvas.getContext("2d");hanzi_html5_redraw(ctx,hzframe,hzfill,size_box)}function hanzi_html5_redraw(ctx,hz_frame,hz_fill,size_box){hanzi_html5_frame(ctx,hz_frame,size_box);hanzi_html5_frame(ctx,hz_frame,size_box);var fill_x=0;var fill_y=0;ctx.lineWidth=3;ctx.strokeStyle="#27931C";ctx.fillStyle="#27931C";ctx.lineJoin="round";ctx.lineCap="round";setTimeout(function(){hanzi_html5_fill(ctx,hz_frame,hz_fill,fill_x,fill_y,size_box)},500)}function hanzi_html5_fill(ctx,hz_frame,hz_fill,fill_x,fill_y,size_box){if(fill_x>=hz_fill.length){setTimeout(function(){hanzi_html5_redraw(ctx,hz_frame,hz_fill,size_box)},1e3);return}next_y=Math.min(hz_fill[fill_x].length,fill_y+40);old_fill_y=fill_y;fill_y=next_y;for(step=old_fill_y;step<next_y;step++){x=hz_fill[fill_x][step][0]*size_box/760;y=hz_fill[fill_x][step][1]*size_box/760;if(step==old_fill_y)ctx.moveTo(x,y);else ctx.lineTo(x,y)}ctx.stroke();if(fill_y>=hz_fill[fill_x].length){fill_x+=1;fill_y=0;setTimeout(function(){hanzi_html5_fill(ctx,hz_frame,hz_fill,fill_x,fill_y,size_box)},400)}else setTimeout(function(){hanzi_html5_fill(ctx,hz_frame,hz_fill,fill_x,fill_y,size_box)},100)}function hanzi_html5_frame(ctx,hz_frame,size_box){ctx.fillStyle="white";ctx.lineWidth=1;ctx.strokeStyle="lightgray";ctx.fillRect(0,0,size_box,size_box);ctx.strokeRect(0,0,size_box,size_box);ctx.fillStyle="lightgray";ctx.moveTo(0,0);ctx.lineTo(size_box,size_box);ctx.moveTo(size_box,0);ctx.lineTo(0,size_box);ctx.moveTo(0,size_box/2);ctx.lineTo(size_box,size_box/2);ctx.moveTo(size_box/2,0);ctx.lineTo(size_box/2,size_box);ctx.stroke();for(line in hz_frame){bihua_data=hz_frame[line];ctx.beginPath();for(dot in bihua_data){x=bihua_data[dot][0]*size_box/760;y=bihua_data[dot][1]*size_box/760;if(dot==0)ctx.moveTo(x,y);else ctx.lineTo(x,y)}ctx.closePath();ctx.fill();ctx.stroke()}ctx.beginPath();ctx.closePath();ctx.stroke()}function v_cr_max_clinet_content(app_audio_height){win_size=window.getWinSize();max_height=win_size[1]-$("#workpanel").offset().top;if($("#player")&&!$("#player").is(":hidden")){max_height=max_height-$("#player").height()}if(app_audio_height){max_height=max_height-app_audio_height}$("#workpanel").css("height",max_height+"px").css("line-height",max_height+"px");v_cr_location_navibutton();v_cr_on_image_load()}function v_cr_location_navibutton(){con_width=$("#workpanel").width();con_height=$("#workpanel").height();bcoffset=$("#workpanel").offset();$("#book_prev").rotate(180);$("#book_prev").css("top",bcoffset.top+con_height-nav_pic_width-20+"px");$("#book_prev").css("left",bcoffset.left+10+"px");$("#book_next").rotate(0);$("#book_next").css("top",bcoffset.top+con_height-nav_pic_width-20+"px");$("#book_next").css("left",bcoffset.left+con_width-nav_pic_width-10+"px")}function v_cr_on_image_load(){$("#canvas").css("top",$("#bookimg").position().top+"px");$("#canvas").css("left",$("#bookimg").position().left+"px");width_canvas=$("#bookimg").width();height_canvas=$("#bookimg").height();$("#canvas").width(width_canvas).height(height_canvas);img_cur_select=imglist[cur_page-1][0];$(".trackrect").hide();$(".trackrect").each(function(){obj=$(this);if(obj.attr("t_img")==img_cur_select){obj.css("top",height_canvas*parseFloat(obj.attr("top"))+"px");obj.css("left",width_canvas*parseFloat(obj.attr("left"))+"px");obj.width((parseFloat(obj.attr("right"))-parseFloat(obj.attr("left")))*width_canvas);obj.height((parseFloat(obj.attr("bottom"))-parseFloat(obj.attr("top")))*height_canvas);obj.show()}})}function v_cr_show_page(page){page=Math.max(page,1);page=Math.min(page,imglist.length);$("#bookimg").attr({src:g_cdn+"/tina/static/"+imglist[page-1][1]});cur_page=page;cur_page<=1?$("#book_prev").hide():$("#book_prev").show();cur_page>=imglist.length?$("#book_next").hide():$("#book_next").show()}function v_cr_start_reading(){$("#book_next").css({opacity:.6});$("#book_prev").css({opacity:.6});$("#book_prev").click(function(){v_cr_show_page(cur_page-1);return false});$("#book_next").click(function(){v_cr_show_page(cur_page+1);return false});v_cr_show_page(1)}function v_cr_after_loading(){$("#voicetip,#overlay").hide();$("#bookimg").load(v_cr_on_image_load);v_cr_on_image_load()}function v_cr_waiting_load(){$(this).addClass("loaded");$(this).removeClass("waiting");count_waiting=$(".waiting").length;count_loaded=$(".loaded").length;count_waiting+=count_loaded;$("#loadtip").html($(this).attr("loadtip"));$("#loadprogress").css("width",count_loaded*100/count_waiting+"%");if(count_loaded>=count_waiting){if((os_platform=="ipad"||os_platform=="iphone"||os_platform=="ipod")&&app_version<app_click_version){$("#loadtip").hide();$("#voicetipbtn").show();$("#voicetipbtn").click(function(){audio_player.play();audio_player.pause();v_cr_after_loading()})}else{v_cr_after_loading()}}}function v_cr_clickread(call_object,retry_count){if(retry_count==undefined){this_object=$(this);retry_count=0}else{this_object=call_object}if(click_read){app_endtime=this_object.attr("auend");mode="clickread"}else{mode="wordread";app_endtime=""}$(".trackrect_tip").hide();if($(this).attr("fy")==""){$(".translate").hide()}else{$(".translate").show()}$(".translate_word").text($(this).attr("fy"));$(this).children(".trackrect_tip").show();if(app_version>=app_click_version&&js_app_send({command:"playaudio",url:book_mp3,mode:mode,tipname:book_name,index:"0",recache:false,duration:duration,begintime:this_object.attr("austart"),endtime:app_endtime})){return}try{$("#auplayer").attr("auend",this_object.attr("auend"));$("#auplayer").attr("click_id",this_object.attr("id"));audio_player.currentTime=parseFloat(this_object.attr("austart"));audio_player.play();diffent=Math.abs(audio_player.currentTime-parseFloat(this_object.attr("austart")));if(diffent<2)return;else audio_player.pause()}catch(e){}if(retry_count<10){setTimeout(function(){v_cr_clickread(this_object,retry_count+1)},100)}}function v_cr_init_trackrect(){$(".trackrect").each(function(){info=$(this).attr("extend").split(";");$(this).attr("left",info[2]).attr("top",info[6]).attr("right",info[0]).attr("bottom",info[8]);$(this).attr("id",info[3]).attr("t_img",info[1]);$(this).attr("austart",info[4]+"."+info[9]).attr("auend",info[7]?info[7]+"."+info[5]:"");$(this).removeAttr("extend")})}function v_cr_main(){v_cr_init_trackrect();if(g_user_agent.indexOf("msie")<0){$(window).resize(function(){v_cr_max_clinet_content()})}else{$.fn.extend({rotate:function(a){}})}v_cr_max_clinet_content();v_cr_start_reading();$(".trackrect").click(v_cr_clickread);$("#auplayer").bind("timeupdate",v_cwr_timeupdate);$("#auplayer").bind("durationchange",function(){$("#duration").html(fmt_time(audio_player.duration))});$("#playstatus").bind(clickevent,function(){if(audio_player.paused)audio_player.play();else audio_player.pause()});$("#clickbar").bind(clickevent,function(e){if(clickevent=="touchstart")offsetX=e.originalEvent.targetTouches[0].pageX-$("#clickbar").offset().left;else offsetX=e.offsetX;if(audio_player.played){new_pos=offsetX*audio_player.duration/$("#progressbar").width();if(new_pos>audio_player.duration)new_pos=audio_player.duration;audio_player.currentTime=new_pos;if(audio_player.paused)audio_player.play()}});$("#auplayer").bind("play",function(){$("#playstatus")[0].src=g_cdn+"/tina/static/audio/pause2.png"});$("#auplayer").bind("pause",function(){$("#playstatus")[0].src=g_cdn+"/tina/static/audio/play2.png"});$("#auplayer").bind("ended",function(){$("#playstatus")[0].src=g_cdn+"/tina/static/audio/play2.png";$(".trackrect_tip").hide();playmode=$('input[name="playmode"]:checked').val();if(playmode=="autorepeat"){audio_player.currentTime=0;audio_player.play()}});$("#wrmodel").bind("click",function(){$(".trackrect_tip").hide();$(".translate").hide();if(click_read){click_read=false;$("#wrmodel").removeClass("button_blue").addClass("button_red").html("回到点读");v_wr_switch($(this))}else{click_read=true;$("#wrmodel").removeClass("button_red").addClass("button_blue").html("连续播放");v_cr_switch($(this))}});fullscreen_modal("voicetip");$("#auplayer").bind("canplaythrough",v_cr_waiting_load);$("#auplayer").bind("progress",v_cr_waiting_load);$("img.waiting").one("load",v_cr_waiting_load).each(function(){if(this.complete)$(this).load()})}function v_cwr_timeupdate(app_audio_curtime){if(click_read){v_cr_timeupdate($(this),app_audio_curtime)}else{v_wr_timeupdate($(this),app_audio_curtime)}}function v_cr_timeupdate(event_object,app_audio_curtime){var tip_obj=$("#"+event_object.attr("click_id"));if(event_object.attr("auend")&&audio_player.currentTime>=parseFloat(event_object.attr("auend"))){tip_obj.children(".trackrect_tip").hide();$(".translate").hide();audio_player.pause()}}function v_wr_timeupdate(event_object,app_audio_curtime){$(".trackrect_tip").hide();$("#curpos").html(fmt_time(audio_player.currentTime));posbar=$("#posbar").parent().width()*audio_player.currentTime/audio_player.duration;$("#posbar").css("width",posbar+"px");$("#posblock").css("left",posbar-$("#posblock").width()/2+"px");last_line=$($(".trackrect")[0]);var c_time=0;$(".trackrect").each(function(){if(app_version>=app_click_version&&app_audio_curtime){c_time=app_audio_curtime}else{c_time=audio_player.currentTime}if(parseFloat($(this).attr("austart"))>c_time){return true}last_line=$(this)});var c_page=0;for(var i=0;i<imglist.length;i++){if(last_line.attr("t_img")==imglist[i][0]){c_page=i+1;break}}if(cur_page!=c_page){v_cr_show_page(c_page)}last_line.children(".trackrect_tip").show();if(last_line.attr("fy")==""){$(".translate").hide()}else{$(".translate").show()}$(".translate_word").text(last_line.attr("fy"))}function v_wr_switch(event_object){var beging_time=0;$(".trackrect").each(function(){if($(this).attr("t_img")==imglist[cur_page-1][0]){beging_time=parseFloat($(this).attr("austart"));return false}});if(app_version>=app_click_version&&js_app_send({command:"playoperate",playstatus:"pause",mode:"clickread"})){js_app_send({command:"playaudio",url:book_mp3,mode:"wordread",tipname:book_name,index:"0",recache:false,duration:duration,begintime:beging_time,endtime:""});js_app_send({command:"playoperate",playstatus:"show",mode:"wordread"});v_cr_max_clinet_content(app_audio_height)}else{audio_player.pause();$("#player").show();v_cr_max_clinet_content();audio_player.currentTime=beging_time;audio_player.play()}}function v_cr_switch(event_object){if(app_version>=app_click_version&&js_app_send({command:"playoperate",playstatus:"hide",mode:"wordread"})){js_app_send({command:"playoperate",playstatus:"pause",mode:"wordread"})}else{$("#player").hide();audio_player.pause()}v_cr_max_clinet_content()}