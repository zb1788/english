<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>课程列表</title>
<style>
 .page{width:auto;height:25px; margin:auto; line-height:25px;}
 .page a{display:block; height:25px; padding:0px 6px; border:solid 1px #e7e7e7; border-radius:3px; color:#333; font-family:'微软雅黑'; font-size:13px; text-align:center; text-decoration:none;float:left; margin-right:10px;min-width:20px;}
 .page a:hover, .page a.this{background:#f7f7f7; font-weight:bold}
</style>
<link href="__PUBLIC__/style/manage.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="__PUBLIC__/js/jquery.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/common.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/jquery.artDialog.js?skin=default"></script>
<script type="text/javascript" src="__PUBLIC__/js/iframeTools.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/jPlayer/dist/jplayer/jquery.jplayer.min.js"></script>
</head>
<body>
<div class="place"><strong>位置</strong>：首页 &gt; 生字添加</div>
<div class="container">
	<table width="100%" border="0" cellspacing="0" cellpadding="0" class="box_border">
	  <tr>
	    <td class="box_top pl_10 f14"><strong id="ks_name"></strong>&nbsp;&nbsp;&nbsp;&nbsp;<input type="button" id="back" value="返回" class="ext_btn ext_btn_listen" /></td>
	  </tr>
	</table>
	<div class="h5"></div>
	<table border="0" cellspacing="0" cellpadding="0" class="form_table">
		<tr>
			<td>
				<input type="button" id="addtype" value="类型管理" class="ext_btn ext_btn_submit" />
        <input type="button" id="btn_100" class="ext_btn ext_btn_success" value="导入语文100内容" />
			</td>
		</tr>
	</table>
  <div class="h10"></div>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="box_border">
        <tr>
        <td class="pl_5"><table border="0" cellspacing="0" cellpadding="0" class="form_table">
          <tr>
            <td>类型：</td>
            <td>
              <select class="select" name="" id="type">
                <option value="1">会写</option>
                <option value="2">会读</option>
                <option value="3">生词</option>
              </select>
            </td>
            <td width="50" align="right">生字：</td>
            <td>
              <input type="text" id="zi" name="szi" class="input-text" style="width:450px;"  />
            </td>
            <td>
            &nbsp;<input type="button" id="btn_so" name="btn_so" class="btn btn82 btn_search" value="查询" />(<font color="red"><strong>请输入要添加的字或词|多个字词用#分割</strong></font>)
            </td>
          </tr>
        </table>
        </td>
        </tr>
    </table>
    <div class="h5"></div>
  <div style="display:none;" id="zibase">
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="box_border" id="dataedit">
      <tr>
        <td class="box_top pl_10 f14"><strong>基本信息（如有问题到基础库修改）</strong></td>
      </tr>
      <tr>
        <td class="p5">
        <table width="100%" border="0" cellspacing="0" cellpadding="0" class="form_table">
          <tr>
            <td id="info">
            </td>
          </tr>
          <tr>
            <td align="left">
              &nbsp;<input type="button" id="btn_addnew"  name="btn_addnew" class="btn btn82 btn_add" value="添加" />
            </td>
          </tr>
    </table>
    </td>
  </tr>
</table>
</div>
<div id="errorMsg" style="color:red;">

</div>
	<div class="h10"></div>
	<table width="100%" border="0" cellpadding="0" cellspacing="0"  class="list_table" id="table_data">
	  <tr>
      <th width="40">序号</th>
      <th width="60">名称</th>
      <th width="60">类型</th>
	    <th width="60">颜色</th>
	    <th >词语</th>
	    <th width="130">管理</th>
	  </tr>
	</table>
	<div class="h5"></div>
</div>
<div class="h5"></div>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="box_border">
  <tr>
    <td class="pl_10" height="42"><input id="btn_submit" type="button" class="ext_btn ext_btn_submit" value="保存次序" /></td>
  </tr>
</table>


<table  style="display:none;" id="demotr">
    <tr class="tr">
      <td><input name="sortid" type="text" class="input-text lh30" size="3" maxlength="2" /></td>
      <td>生词</td>
      <td align="center" ></td>
      <td align="center" ></td>
      <td align="center" ></td>
      <td align="center">
      <input type="button" class="ext_btn ext_btn_submit" value="管理" name="manager" />
      <input type="button" class="ext_btn ext_btn_error" value="删除" name="del" />
      </td>
    </tr>
</table>


<table style="display:none;" id="demo">
  <tr class="tr">
    <td><input name="sortid" type="text" class="input-text lh30" size="3" maxlength="2" /></td>
    <td align="left">字</td>
    <td align="left">
      &nbsp;<input type="button" name="edit" class="ext_btn ext_btn_success" value="编辑" />
      <input type="button" name="ting" value="试听" class="ext_btn ext_btn_listen" />
      <if condition="$style eq 2">
      <input type="button" name="fy" value="课文翻译" class="ext_btn ext_btn_submit" />
      <input type="button" name="js" value="词语解释" class="ext_btn ext_btn_submit" />
      </if>
      <input type="button" name="del" value="删除" class="ext_btn ext_btn_error" />
    </td>
  </tr>
</table>
<div id="jplayer"></div>

</body>
</html>
<script type="text/javascript">
var pagesize=10;
$(function(){
  $.ajaxSetup({async:false});
  var ks_name = '{$ks_name}';
  $("#ks_name").html(ks_name);
  gettype();
  pagelist();
});

function pagelist(){
  $.get('../Kewen/pagelist',
    {
      ks_code:'{$ks_code}',
      ran:Math.random()
    },
    function(data){
      $('#table_data tr:not(:first)').remove();
      $.each(data,function(k,v){
        var tr=$('#demotr').children('tbody').children('tr').eq(0).clone();
        tr.children('td').eq(0).find('input').val(k+1);
        tr.children('td').eq(1).html(v.typename);
        tr.children('td').eq(2).html(v.type==1?'字':'词');
        var colorinfo;
        if(v.color == 1){
            colorinfo = '绿色';
        }else if(v.color == 2){
            colorinfo = '蓝色';
        }else{
            colorinfo = '无';
        }
        tr.children('td').eq(3).html(colorinfo);
        var str = '';
        $.each(v.info,function(kk,vv){
          str += vv.word;
          str += ' ';
        });
        tr.children('td').eq(4).html(str);
        tr.children('td').find('input').attr('listid',v.id);
        tr.appendTo('#table_data');
      })
    })
}

//获取类型列表
function gettype(){
  $('#type').empty();
  $.get('../Kewen/typelist',function(data){
    $.each(data, function(i, v) {
        $('#type').append($("<option>").val(v.id).text(v.name).attr('leixing',v.type));
    });
  })
}


$('#back').click(function(){
	history.go(-1);
});

$('#addtype').click(function(){
    var myDialog = $.dialog.open('typeinfo',{
    title:'类型管理',
    window : 'top',
    width : 520,
    height : 350,
    lock : true,
    opacity : 0.3,
    button : [
         {
          name : '关闭',
          callback : function() {
            gettype();
            return true;
          },
          focus : false
        } ]
  });

  // var title = $('#title').val();
  // if(title == ""){
  //   art.dialog.alert('名称不能为空！');
  //   return false;
  // }

  // $.get('../Kewen/addType',
  //   {
  //     ran:Math.random(),
  //     title:title,
  //     ks_code:'{$ks_code}'
  //   },function(data){

  // });
});

//去除两边空白
String.prototype.trim = function() {
  return this.replace(/(^\s*)|(\s*$)/g, '');
};
//去除两边#
String.prototype.trim3 = function() {
  return this.replace(/(^#*)|(#*$)/g, '');
};


//查询
$("#btn_so").click(function(){
    $('#errorMsg').html("");
    var word_type_id = $('#type').val();
    var leixing = $('#type option:selected').attr('leixing');

    var zi = $('#zi').val();

    if(zi == ''){
      art.dialog.alert('不能为空！');
      return false;
    }

    zi = zi.trim().trim3();
    var ziArr = zi.split('#');

    var flag = true;
    $.each(ziArr,function(k,v){
      var len = v.length;
      if(leixing == 1){
          if(len>1){
              flag = false;
          }
      }
    })
    if(!flag){
      art.dialog.alert('不能查询词语！');
      return flag;
    }
    $('#info').html('');
    $.get('../Kewen/getPinyin',
        {
            word_type_id:word_type_id,
            zi:zi,
            leixing:leixing,
            ran:Math.random()
        },
        function(data){
          if(data != null && data != ''){
            addInfo(leixing,data);
            $('#zibase').show();
          }else{
            $('#zibase').hide();
            art.dialog.alert('找不到【'+zi+'】,请在基础词库添加!');
            return false;
          }
        })
})



function addInfo(leixing,data){
  var word_type_id = $('#type').val();


    var htmlZi = '<div class="h5"></div><table width="100%" height="90" class="list_table" >';
    htmlZi += '<tr>';
    htmlZi += '<th width="33">&nbsp;</th>';
    htmlZi += '<th width="20">字</th>';
    htmlZi += '<th width="55">拼音</th>';
    htmlZi += '<th width="55">试听</th>';
    htmlZi += '<th>组词</th>';
    htmlZi += '</tr>';

    var htmlCi = '<div class="h5"></div><table width="100%" height="90" class="list_table" >';
    htmlCi += '<tr>';
    htmlCi += '<th>&nbsp;</th>';
    htmlCi += '<th width="110">词语</th>';
    htmlCi += '<th width="130">拼音</th>';
    htmlCi += '<th width="55">试听</th>';
    htmlCi += '<th>近义词</th>';
    htmlCi += '<th>反义词</th>';
    htmlCi += '</tr>';

    var ziCount = 0;
    var ciCount = 0;
  $.each(data,function(k,v){
    if(v == null){
      return true;
    }
    if(typeof(v.ci) == 'undefined'){
      //字
      var length = v.length;
      $.each(v,function(kk,vv){
        ziCount++;
        htmlZi += '<tr>';

        htmlZi += '<td><input type="checkbox" name="item" value="'+vv.zi+'" py="'+vv.zi_pinyin+'" fy="'+vv.py+'" typeid="'+word_type_id+'" leixing="'+leixing+'" /></td>';
        htmlZi += '<td>'+vv.zi+'</td>';
        htmlZi += '<td>'+vv.zi_pinyin+'</td>';
        htmlZi += '<td><input type="button" name="ting" typeid="'+word_type_id+'" url="'+vv.py+'" class="ext_btn ext_btn_listen" value="试听"/></td>';
        htmlZi += '<td>'+vv.cizu+'</td>';
        htmlZi += '</tr>';
      })
    }else{
      //词
      ciCount++;
      htmlCi += '<tr>';
      htmlCi += '<td><input type="checkbox" name="item" value="'+v.ci+'" py="'+v.pinyin+'" fy="'+v.voice+'" typeid="'+word_type_id+'" leixing="'+leixing+'"  /></td>';
      htmlCi += '<td>'+v.ci+'</td>';
      htmlCi += '<td>'+v.pinyin+'</td>';
      htmlCi += '<td><input type="button" name="ting" typeid="'+word_type_id+'" leixing="'+leixing+'"  url="'+v.voice+'" class="ext_btn ext_btn_listen" value="试听"/></td>';
      htmlCi += '<td>'+v.tongyici+'</td>';
      htmlCi += '<td>'+v.fanyici+'</td>';
      htmlCi += '</tr>';
    }
  });
  htmlZi += '</table>';
  htmlCi += '</table>';
  if(ciCount==0){
    htmlCi = '';
  }
  if(ziCount==0){
    htmlZi = '';
  }
  $('#info').html(htmlZi+htmlCi);
}

// 播放音频
$('input[name="ting"]').live('click',function(){
    jpclear();
    var mp3 = $(this).attr('url');
    var arr= new Array();
    arr = mp3.split("|");
    if(arr.length == 1){
      var path = '../../uploadsyw/zipinyin/'+mp3+'.mp3';
      jpstart(path);
    }else{
      play(arr);
    }


})

//连续播放
function play(mp3arr){
     var num=0;
     var total=mp3arr.length;
     jpstart('../../uploadsyw/zipinyin/'+mp3arr[num]);
     $("#jplayer").bind($.jPlayer.event.ended, function(event) {
        num++;
        if(num<total){
             jpstart('../../uploadsyw/zipinyin/'+mp3arr[num]);
        }
      });
}

//获取多个字词的内容
function getCheckBoxValue(){
  var chk_value = [];
  var count = 0;
  //循环获取多选框的值
  $('input[name="item"]:checked').each(function() {
      count++;
      var obj ={};
      obj.word_type_id = $(this).attr('typeid');
      obj.content = $(this).val()
      obj.py = $(this).attr('py');
      obj.fy = $(this).attr('fy');
      obj.leixing = $(this).attr('leixing');
      obj.py = $(this).attr('py');
      chk_value.push(obj);
  });
  if(count == 0){
    art.dialog.alert('至少选择一个!');
    return false;
  }
  return JSON.stringify(chk_value);
}


//点击添加按钮
  $('#btn_addnew').click(function(){
    var infos = getCheckBoxValue();
    $.post('../Kewen/addContent',
      {
        ran:Math.random(),
        infos:infos,
        ks_code:'{$ks_code}'
      },
      function(data){
        //art.dialog.alert('添加成功');
        $('#errorMsg').html(data);
        pagelist();
        $('[name=item]:checkbox').prop("checked",false);
      });
  })

//导入语文100
$('#btn_100').click(function(){
    var ks_code= '{$ks_code}';
    var myDialog = $.dialog.open('importzici?ks_code='+ks_code+'&ran='+Math.random(),{
        title:'选择课文章节',
        window : 'top',
        width : 790,
        height : 400,
        lock : true,
        opacity : 0.3,
        button : [
                 {
                    name:'保存',
                    callback:function(){
                        var iframe = this.iframe.contentWindow;
                        var re = iframe.savedata();//调用窗口的方法
                        if(re==false){
                            art.dialog.alert('添加失败！');
                        }else{
                          pagelist();
                        }
                        return re;
                    },
                    focus:true
                 },
                 {
                    name : '关闭',
                    callback : function() {
                        return true;
                    },
                    focus : false
                } ]
    });
});



$('input[name="manager"]').live('click',function(){
  var listid = $(this).attr('listid');
  edition(listid);
});

//管理字词
function edition(listid){

  var ks_code = '{$ks_code}';
  var myDialog = $.dialog.open('ziciedit?ks_code='+ks_code+'&listid='+listid+'&ran='+Math.random(),{
    title:'管理字词',
    window : 'top',
    width : 885,
    height : 446,
    lock : true,
    opacity : 0.3,
    button : [
         {
          name : '关闭',
          callback : function() {
            return true;
          },
          focus : false
        } ]
  });
}

//保存排序
 $("#btn_submit").click(function()
  {
    var dloading = art.dialog({time:30,title:'更新中……',width:130,height:30,opacity:0.3,lock:true});
    // if($("#table_data tr.tr").length == 0)return;
    var arrjson =[];
    $("#table_data tr.tr").each(function(){
      var tr =$(this);
      var id = tr.find('input[name="sortid"]').attr("listid");
      var sortid = tr.find('input[name="sortid"]').val();
      var obj = {};
      obj.id = id;
      obj.sortid = sortid;
      arrjson.push(obj);
    });
    $.get("../Kewen/upTypeSort",{data:JSON.stringify(arrjson)},function(){
      pagelist();
      dloading.close();
      art.dialog.alert("排序保存成功");
    });

  });

//删除背景
$('input[name="del"]').live('click',function(){
  var id=$(this).attr('listid');
  var aa=$(this).parent().parent();
  //alert($(this).parent().parent().html());return false;
  $.get('../kewen/delUnitType',{ran:Math.random(),id:id},function(data){
    if(data=='ok'){
      $(aa).remove();
    }else{
      art.dialog.alert('正在使用，无法删除！');
            return false;
    }

  });
});






function jpclear() {
  $("#jplayer").jPlayer("clearMedia");
  $("#jplayer").jPlayer("stop");
  $("#jplayer").unbind($.jPlayer.event.ended);
  $("#jplayer").unbind($.jPlayer.event.progress);
}

function jpstart(mp3){
	$("#jplayer").jPlayer({
    swfPath: "js",
    wmode: "window",
    supplied: "mp3",
    preload: "none",
    volume: "1"
  });
	$("#jplayer").jPlayer("setMedia", {
	    mp3: mp3
	}).jPlayer("play");
}

</script>
