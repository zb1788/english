<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=0.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <meta name="wap-font-scale" content="no">
        <meta charset="UTF-8">
        <title>口算卡</title>
        <link href="__PUBLIC__/css/ksk.css" rel="stylesheet" type="text/css" />
        <link href="__PUBLIC__/font/fonts.css" rel="stylesheet" type="text/css" />
        <link href="__PUBLIC__/font/back.css" rel="stylesheet" type="text/css" />
        <link href="__PUBLIC__/css/iscroll.css" rel="stylesheet" type="text/css" />
        <script src="__PUBLIC__/js/zepto.min.js" type="text/javascript"></script>
        <script src="__PUBLIC__/js/demoUtils.js" type="text/javascript"></script>
        <script src="__PUBLIC__/js/TouchSlide.1.1.js" type="text/javascript"></script>
        <style>
            .daan{
                border:solid 1px #fff;
                display:inline-block;
                width:45px;
                height:33px;
                line-height:33px;
                background: #fff;
                text-align:center;
                vertical-align: middle;
                }
            a.redeay {display: block;width: 80px; height: 80px; background:#56c1c0; color: #fff; font-size: 1.2em; font-weight: bold; line-height: 80px; text-align: center; border-radius: 40px; -moz-border-radius:40px; -webkit-border-radius:40px; margin: 20px auto 0;}
            a.redeay:hover,a.redeay:visited {background: #39a8a7;}
            .fenshuw {width:100px;}
            #tips {background-color:#333; display:block; position:fixed; bottom:50%; left:3%; color:#fff; border-radius:5px; opacity:.92; padding:10px; width:90%; display:none; box-shadow: 1px 1px 5px #555; text-align:center; z-index:1000;}
            #tips img {vertical-align: text-top;}

        </style>
    </head>
<body>
<header class="head">
            <a class="head-left"><i class="icon-back"></i>返回</a>
            <h1><font id="time">60</font>秒</h1>
                    </header>

<section>
<div class="pan cuo " id="wrongflag" style="display:none;"><i  class="icon-error02"></i></div>
<div class="pan dui" id="rightflag" style="display:none;"><i class="icon-correct02"></i></div>
<div class="content">
    <div class="time"><span></span><i></i></div>
    <h5 class="yeq"><font id="jindu">1</font>/15</h5>
    <!-- <button class="begdt"  style="width:100px;height:40px;">开始答题</button> -->
    <a class="redeay">开 始</a>
    <!--正常 1-->
    <div class="timu" id="style1" style="display:none;"><span id="style11" style="vertical-align:middle;"><font id="shizi">7+4</font>=</span><div class="daan" id="answer" >( )</div></div>
    <!--分数 2 -->
    <div class="timuf" id="style2" style="display:none;">
        <div id="style22"><span style="width:20px;"><b style="width:20px;line-height:40px;"><font id="fenzi_1"></font></b><s></s><b style="width:20px;line-height:40px;"><font id="fenmu_1"></font></b></span><strong><font id="fuhao"></font></strong><span style="width:20px;"><b style="width:20px;line-height:40px;"><font id="fenzi_2"></font></b><s></s><b style="width:20px;line-height:40px;"><font id="fenmu_2"></font></b></span><strong>=</strong></div><span><b>(<div class="daan" id="fenzi_3" onclick="qiehuanShuru(this);"></div>)</b><s></s><b>(<div class="daan" id="fenmu_3" onclick="qiehuanShuru(this);"></div>)</b></span>
        <div class="clearfix"></div>
    </div>
    <!--余数 3 -->
    <div class="timu" id="style3" style="display:none;">
        <span id="style33"><font id="shizi1">7+4</font>=</span>(<div class="daan" id="yushu1" onclick="qiehuanShuru(this);"></div>)...(<div class="daan" id="yushu2" onclick="qiehuanShuru(this);"></div>)
    </div>
</div>
</section>
  <div id="bg" style="display: block;"></div>
  <div class="cgbd pad10">
    <h1 class="cgH1">闯关宝典</h1>
    <h3 class="textH3">练习技巧：</h3>
    <p>{$data.keypoint}</p>
    <h3 class="textH3">练习举例：</h3>
    <p>{$data.example}</p>
    <h3 class="textH3">解题思路：</h3>
    <p>{$data.thinking}</p>
    <div class="boxCon"><a href="#" class="btn bDefault closeCG"><i class="icon-kwdd2"></i>开始练习</a></div>
  </div>
<div class="zit_box" style="display:none">
<span >还有题目未做完，您要放弃本次作答吗？</span>
<a class="zit_close" id="quxiao" style="border-left:0;">取消</a><a id="queding" class="zit_close">确定</a>
</div>
<div class="keyboard">

<table border="1" cellspacing="0" cellpadding="0" >
<tr><td><a val="1" name="tijiao" onclick="userSubmit(this);">1</a></td><td><a val="2" name="tijiao" onclick="userSubmit(this);">2</a></td><td><a val="3" name="tijiao" onclick="userSubmit(this);">3</a></td><td><a val="bac" name="tijiao" onclick="userSubmit(this);" class="redFont">删除</a></td></tr>
<tr><td><a val="4" name="tijiao" onclick="userSubmit(this);">4</a></td><td><a val="5" name="tijiao" onclick="userSubmit(this);">5</a></td><td><a val="6" name="tijiao" onclick="userSubmit(this);">6</a></td><td isUse="1" rowspan="3" valign="middle" class="dd"><span id="buttonText">下一题</span></td>
</tr>
<tr><td><a val="7" name="tijiao" onclick="userSubmit(this);">7</a></td><td><a val="8" name="tijiao" onclick="userSubmit(this);">8</a></td><td><a val="9" name="tijiao" onclick="userSubmit(this);">9</a></td></tr>
<tr><td><a val="0" name="tijiao" onclick="userSubmit(this);">0</a></td><td><a val="." name="tijiao" onclick="userSubmit(this);">.</a></td><td><a val="00" name="tijiao" onclick="userSubmit(this);">00</a></td></tr>
</table>
</div><!--end keyboard-->
<div id="tips"></div>
<script type="text/javascript">
var needHideProgress = false;
    try{
        UXinJSInterface.hideProgress();
    }catch(e){
        needHideProgress =true;
    }
</script>
<script type="text/javascript">
var t;
/*
if('{$type}'==1){
    if('{$geshi}'==1){
        var time=60;//倒计时
        var totaltime=60;
    }else{
        var time=120;//倒计时
        var totaltime=120;
    }

}else{
   var time=120;//倒计时
   var totaltime=120;
}
*/
var time = '{$times}';
var totaltime = '{$times}';

var isStart = false;

var domain = '__RESOURCE__/uploadklx/klxsx/nan/';
var count=0;
var array=[];//存储试题信息
var arrAnswer=[];//存储答案信息
var usetime=0;//用时
var total_eq=15;//题目总数
var tmpcount=14;
var right=0;
var wrong=0;
var tmpstr='';
var mp3count = 0;
var mp3arr;
var errPlayNum = 0;
var downloadJson;
String.prototype.trimStr = function(str) {
  return this.replace(eval('/(^'+str+'*)|('+str+'*$)/g'), '');
};

$(function(){
    submitInfo();
    $.get('../Ksk/getinfo', {
            ran: Math.random(),
            bid: '{$bid}'
        }, function(data){
            downloadJson = '[';
            var voiceArr = [];
            $.each(data, function(k, v){
                // alert(v.equation);
                //array.push(v.equation);
                var tmp={};
                tmp.id=v.id;
                tmp.name=v.equation;
                tmp.voice=v.voice;
                array.push(tmp);
                $.each(eval("("+v.voice+")"),function(kk,vv){
                    voiceArr.push(vv);
                });
            });
            $.each(voiceArr.unique3(),function(k,v){
                downloadJson += '{"name":"'+v+'","size":"10","format":"mp3","url":"'+domain+v+'.mp3"},';
            });
            downloadJson = downloadJson.trimStr(',');
            downloadJson += ']';
            if('{$type}'==2){
                setTimeout("downloadAudio()",800);
                // UXinJSInterfaceSpeech.cacheAudioFiles(iGetInnerText(downloadJson));
            }
        });
    $('#time').html(totaltime);
})

function downloadAudio(){
    // console.log(eval('('+downloadJson+')'));
    UXinJSInterfaceSpeech.cacheAudioFiles(iGetInnerText(downloadJson));
}

Array.prototype.unique3 = function(){
 var res = [];
 var json = {};
 for(var i = 0; i < this.length; i++){
  if(!json[this[i]]){
   res.push(this[i]);
   json[this[i]] = 1;
  }
 }
 return res;
}
function submitInfo(){
    $.ajax({
            url: '../../Subject/Public/setUserModuleUnitLog',
            data: {ran:Math.random(),ks_code:0,moduleid:13,ks_name:'{$name}'},
            // datatype: "json",
            type: 'get',
            async: false,
            success: function (data) {   //成功后回调

            },
            error: function(e){    //失败后回调
                // alert(e);
            },
            beforeSend: function(){  //发送请求前调用，可以放一些"正在加载"之类额话
                // alert("正在加载");
            }
    });
}




function onCacheAudioStatus(status){
    if(0 == status){
        // alert("下載成功");
    }else{
        // alert("下載出錯");
    }
}
function iGetInnerText(testStr) {
    var resultStr = testStr.replace(/\ +/g, ""); //去掉空格
    resultStr = testStr.replace(/[ ]/g, "");    //去掉空格
    resultStr = testStr.replace(/[\r\n]/g, ""); //去掉回车换行
    return resultStr;
}
$('.redeay').click(function(){
    isStart = true;
        if('{$type}'==1){
            if('{$geshi}'==1){
                $("#shizi").html(array[0].name);
                $('#style1').show();
                $('#style2').hide();
                $('#style3').hide();
            }else if('{$geshi}'==2){
                $('.timuf').removeClass('fenshuw');
                var strs=strFormat(array[0].name);
                var strarray=[];
                strarray=strs.split(',');
                $('#fenzi_1').html(strarray[0]);
                $('#fenmu_1').html(strarray[1]);
                $('#fenzi_2').html(strarray[2]);
                $('#fenmu_2').html(strarray[3]);
                $('#fuhao').html(strarray[4]);

                $('#fenmu_3').addClass('currentnow');
                $('#style1').hide();
                $("#style2").show();
                $('#style3').hide();
            }else{
                $("#shizi1").html(array[0].name);
                $('#yushu1').addClass('currentnow');
                $('#style1').hide();
                $('#style2').hide();
                $('#style3').show();
            }
        }else{
            $("#laba").show();
            //alert('aa');
            //听算
            if('{$geshi}'==1){
                $("#shizi").html(array[0].name);

                mp3arr=eval('('+array[0].voice+')');//获取MP3数组

                $('#style1').show();
                $('#style11').hide();
                $('#style2').hide();
                $('#style3').hide();


            }else if('{$geshi}'==2){
                $('.timuf').addClass('fenshuw');
                mp3arr=eval('('+array[0].voice+')');
                var strs=strFormat(array[0].name);
                var strarray=[];
                strarray=strs.split(',');
                $('#fenzi_1').html(strarray[0]);
                $('#fenmu_1').html(strarray[1]);
                $('#fenzi_2').html(strarray[2]);
                $('#fenmu_2').html(strarray[3]);
                $('#fuhao').html(strarray[4]);

                $('#fenmu_3').addClass('currentnow');
                $('#style1').hide();
                $("#style2").show();
                $("#style22").hide();
                $('#style3').hide();
            }else{
                mp3arr=eval('('+array[0].voice+')');
                $("#shizi1").html(array[0].name);
                $('#style1').hide();
                $('#style2').hide();
                $('#style3').show();
                $('#style33').hide();
                $('#yushu1').addClass('currentnow');
            }
            play(mp3arr);

        }
        $('.redeay').hide();
        $('.tm_next').show();
        showTime();
});


function play(mp3arr){
    mp3count = 0;
    UXinJSInterfaceSpeech.playAudio(mp3arr[mp3count]+'.mp3');
}

function onAudioPlayStatus(status){
    if(status == 0){
        mp3count++;
        if(mp3count<mp3arr.length){
            UXinJSInterfaceSpeech.playAudio(mp3arr[mp3count]+'.mp3');
        }
    }else{
        errPlayNum++;
        if(errPlayNum<2){
            // play(mp3arr);
            UXinJSInterfaceSpeech.playAudio(domain+'nan/'+mp3arr[mp3count]+'.mp3');
        }
    }
}

//用户输入

function userSubmit(obj){
    if(isStart){
        if('{$geshi}'==1){
            var type=1;
        }else if('{$geshi}'==2){
            var type=2;
        }else{
            var type=3;
        }
        submit(obj,type);
    }
}

//用户输入答案
function submit(obj,type){
    var val=$(obj).attr('val');
    if(val=='+'||val=='-'||val=='*'||val=='/'||val=='('||val==')'){
        return false;
    }
    var str='';
    var str1='';
    if(type==1){
        str=$('#answer').html();
        str = str.replace('(','');
        str = str.replace(')','');
        str = str.replace(' ','');
        //alert(str.length);
        if(val=='bac'){
                str = str.substr(0,(str.length-1));
        }else{
            if(checkAnswer(str)){
                str +=val;
            }
        }
        //$('#answer').html(str);
        str = '('+str+')';
        $('#answer').html(str);
    }else if(type==2){
        str=$('.currentnow').html();
        if(val=='bac'){
                str='';
        }else{
            if(checkAnswer(str)){
                str +=val;
            }
        }

        $('.currentnow').html(str);

    }else{
        str=$('.currentnow').html();
        if(val=='bac'){
                str='';
        }else{
            if(checkAnswer(str)){
                str +=val;
            }
        }
        $('.currentnow').html(str);

    }


}

//验证用户输入
function checkAnswer(str){
    //如果长度超过10位不能输入
    if(str.length>=6){
        return false;
    }else{
        return true;
    }
}


var flags = 0;
 function start(){
    var text = document.getElementById("time");
    if (!flags)
    {
        text.style.color = "#d04949";
        text.style.background = "#fff266";
        flags = 1;
    }else{
        //alert('b');
        text.style.color = "";
        text.style.background = "";
        flags = 0;
    }
    setTimeout("start()",500);
 }

 function start2(){
    var text = document.getElementById("time");
    text.style.color = "#d04949";
    text.style.background = "#fff266";
 }

function showTime(){
        time-=1;
        if(time==10){
           start();
        }
        $('#time').html(time);
        if (time==0){
            // $('.tips').html("<img src='__PUBLIC__/images/no_ico.png' width='20' height='20' />&nbsp;时间到！");
            // $('.tips').fadeIn(300).delay(1000).fadeOut(300);
            setTip("时间到");

             setTimeout(function(){location.href='../Ksk/result?right='+right+'&wrong='+wrong+'&tmpstr='+tmpstr+'&usetime='+totaltime+'&bid={$bid}&type={$type}&geshi={$geshi}&grade={$grade}&name={$name}&times={$times}&backUrl={$backUrl}';},2000);
            return false;
        }else{
            t=setTimeout("showTime()",1000);
        }


}
//提示信息
function setTip(content){
    var tip = document.getElementById('tips');
    tip.innerHTML = content;
    tip.style.display = 'block';
    setTimeout(function(){
        tip.style.display = 'none';
    }, 1000);
}

//不能连续点下一体，间隔1秒
$('.dd').click(function(){
    if(isStart){
        var flag = $('.dd').attr("isUse");
        //alert(flag);
        if(flag==1){
            tijiao();
            $('.dd').attr("isUse","0");
            setTimeout(function(){$('.dd').attr("isUse","1");},1000);
        }
    }

});

//提交
function tijiao(){
count++;
if(count<15){
var bili=Math.round((count+1)/15*100);

 if (/i(Phone|P(o|a)d)/.test(navigator.userAgent)) {
        //苹果
        $('.time span').css('width',(bili-1)+'%');
        bili = bili - 11;
        $('.time i').css('left',(bili-3)+'%');
    }else{
        //安卓
        $('.time span').css('width',(bili-1)+'%');
        $('.time i').css('left',(bili-5)+'%');
    }
}

if(count == 14){
    $('#buttonText').html('提交');
}

$('#jindu').html(count+1);//进度

if ('{$geshi}' == 1) {

    var answer=$('#answer').html();
    answer = answer.replace('(','');
    answer = answer.replace(')','');
    var str_name = array[count-1].name;
    //str_name = str_name.replace('×','*');
    str_name = str_name.replace(new RegExp('×',"gm"),'*');
    //str_name = str_name.replace('÷','/');
    str_name = str_name.replace(new RegExp('÷',"gm"),'/');


    if(str_name.indexOf('.')<0){
        var result=eval(str_name);
    }else{
        //小数,木前只是一位小数
        var result=Number(eval(str_name).toFixed(1));
    }

    if(answer==result&&answer!=' '){
        right++;
        tmpstr+='r';
        // UXinJSInterfaceSpeech.playAudio(domain+'yes.mp3');
        $('#rightflag').show();
        $('#wrongflag').hide();
    }else{
        if(answer!=''){
            wrong++;
        }
        tmpstr+='|';
        // UXinJSInterfaceSpeech.playAudio(domain+'no.mp3');
        $('#rightflag').hide();
        $('#wrongflag').show();
    }
    $('.content').hide();

    if(count<15){
        if('{$type}'==2){
            mp3arr=eval('('+array[count].voice+')');
            setTimeout(function(){play(mp3arr);},1200);
        }
        $("#shizi").html(array[count].name);

        //清除答案
        $('#answer').html('( )');
        $('#yushu1').html('');
        $('#yushu2').html('');
        $('#fenzi_3').html('');
        $('#fenmu_3').html('');

        setTimeout(function(){$('.content').show();$('.pan').hide();},500);
    }else{
        $('.time span').css('width','100%');
        $('.time i').css('left','97%');

        usetime=$('#time').html();//取出用时
        usetime=totaltime-usetime;
        setTimeout(function(){location.href='../Ksk/result?right='+right+'&wrong='+wrong+'&tmpstr='+tmpstr+'&usetime='+usetime+'&bid={$bid}&type={$type}&geshi={$geshi}&grade={$grade}&name={$name}&times={$times}&backUrl={$backUrl}';},500);
    }

}
else if ('{$geshi}' == 2) {
    //目前只适合同分母的算法
    var fenzi_1=$('#fenzi_1').html();
    var fenmu_1=$('#fenmu_1').html();
    var fenzi_2=$('#fenzi_2').html();
    var fenmu_2=$('#fenmu_2').html();
    var fenzi_3=$('#fenzi_3').html();
    var fenmu_3=$('#fenmu_3').html();
    var fuhao=$('#fuhao').html();

    var fenzi_total=fenzi_1+fuhao+fenzi_2;
    var fenmu_total=fenmu_1;
    //alert(eval(fenzi_total));
    //alert(fenzi_1+''+fenzi_2+''+fenzi_total+'='+fenzi_3);
    if(fenzi_3==eval(fenzi_total)&&fenmu_3==fenmu_total&&fenzi_3!=''&&fenmu_3!=''){
        right++;
        tmpstr+='r';
        // UXinJSInterfaceSpeech.playAudio(domain+'yes.mp3');
        $('#rightflag').show();
        $('#wrongflag').hide();
    }else{
        if(fenzi_3!=''&&fenmu_3!=''){
            wrong++;
        }
        tmpstr+='|';
        // UXinJSInterfaceSpeech.playAudio(domain+'no.mp3');
        $('#rightflag').hide();
        $('#wrongflag').show();
    }
    $('.content').hide();
    $('.daan').removeClass('currentnow');
    if(count<15){
        $('#fenmu_3').addClass('currentnow');
        if('{$type}'==2){
            mp3arr=eval('('+array[count].voice+')');
            setTimeout(function(){play(mp3arr);},1200);
        }

        var strs=strFormat(array[count].name);
        var strarray=[];
        strarray=strs.split(',');
        $('#fenzi_1').html(strarray[0]);
        $('#fenmu_1').html(strarray[1]);
        $('#fenzi_2').html(strarray[2]);
        $('#fenmu_2').html(strarray[3]);
        $('#fuhao').html(strarray[4]);

        //清除答案
        $('#answer').html('( )');
        $('#yushu1').html('');
        $('#yushu2').html('');
        $('#fenzi_3').html('');
        $('#fenmu_3').html('');
        setTimeout(function(){$('.content').show();$('.pan').hide();},500);
    }else{
        $('.time span').css('width','100%');
        $('.time i').css('left','97%');

        usetime=$('#time').html();//取出用时
        usetime=totaltime-usetime;
        setTimeout(function(){location.href='../Ksk/result?right='+right+'&wrong='+wrong+'&tmpstr='+tmpstr+'&usetime='+usetime+'&bid={$bid}&type={$type}&geshi={$geshi}&grade={$grade}&name={$name}&times={$times}&backUrl={$backUrl}';},500);
    }

}else{
    var yushu1=$('#yushu1').html();
    var yushu2=$('#yushu2').html();
    var str=array[count-1].name;
    str1=str.replace('÷','/');
    var result1=parseInt(eval(str1));
    str2=str.replace('÷','%');
    var result2=parseInt(eval(str2));

    if(yushu1==result1&&yushu2==result2&&yushu1!=''&&yushu2!=''){
        right++;
        // UXinJSInterfaceSpeech.playAudio(domain+'yes.mp3');
        $('#rightflag').show();
        $('#wrongflag').hide();
        //alert('1');
    }else{
        if(yushu1!=''&&yushu2!=''){
            wrong++;
        }
        // UXinJSInterfaceSpeech.playAudio(domain+'no.mp3');
        $('#rightflag').hide();
        $('#wrongflag').show();
        //alert('0');
    }
    $('.content').hide();
    $('.daan').removeClass('currentnow');
    if(count<15){
        if('{$type}'==2){
            mp3arr=eval('('+array[count].voice+')');
            play(mp3arr);
        }
        $('#yushu1').addClass('currentnow');
        $("#shizi1").html(array[count].name);
        //清除答案
        $('#answer').html('( )');
        $('#yushu1').html('');
        $('#yushu2').html('');
        $('#fenzi_3').html('');
        $('#fenmu_3').html('');

        setTimeout(function(){$('.content').show();$('.pan').hide();},500);
    }else{
        $('.time span').css('width','100%');
        $('.time i').css('left','97%');

        usetime=$('#time').html();//取出用时
        usetime=totaltime-usetime;
        setTimeout(function(){location.href='../Ksk/result?right='+right+'&wrong='+wrong+'&tmpstr='+tmpstr+'&usetime='+usetime+'&bid={$bid}&type={$type}&geshi={$geshi}&grade={$grade}&name={$name}&times={$times}&backUrl={$backUrl}';},500);
    }

}




}



function qiehuanShuru(obj){
    $('.daan').removeClass('currentnow');
    $(obj).addClass('currentnow');
}
//分数拆分
function strFormat(str){
    var array1=[];
    var array2=[];
    var array3=[];
    var fuhao='';
    if(str.indexOf("+")>0){
        array1=str.split('+');
        fuhao='+';
    }else{
        array1=str.split('-');
        fuhao='-';
    }

    array2=array1[0].split('/');
    array3=array1[1].split('/');
    return array2[0]+','+array2[1]+','+array3[0]+','+array3[1]+','+fuhao;
}

$("a.head-left").click(function () {
    if(!isStart){
        window.location.href="lists?grade={$grade}&type={$type}&backUrl={$backUrl}";
    }else{
        $("#bg").css({
            display: "block", height: $(window).height()
        });
        var $box = $('.zit_box');
        $box.css({
            display: "block"
        });
    }
});
    //点击关闭按钮的时候，遮罩层关闭，确定返回
    $("#queding").click(function () {
        $("#bg,.zit_box").css("display", "none");
        window.location.href="lists?grade={$grade}&type={$type}&backUrl={$backUrl}";
    });
    $('#quxiao').click(function(){
        $("#bg,.zit_box").css("display", "none");
    });
    $('input').focus(function(){
        $(this).addClass('backGef').removeClass('backGfff');
    })
    $('input').blur(function(){
        $(this).addClass('backGfff').removeClass('backGef');
    })
    $('.closeCG').click(function(){
        $('.cgbd').hide();
        $('#bg').hide();
    })











</script>
</body>

</html>