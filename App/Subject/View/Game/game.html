<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=0.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="wap-font-scale" content="no">
	<meta charset="UTF-8">
	<title>英语闯关</title>
	<link rel="stylesheet" href="__SUBJECT__game/css/css.css" />
	<link rel="stylesheet" href="__SUBJECT__game/font/style.css" />
	<link rel="stylesheet" href="__SUBJECT__game/css/iscroll.css" />
	<link rel="stylesheet" href="__SUBJECT__game/css/button.css" />
	<link rel="stylesheet" href="__SUBJECT__game/css/animate.min.css" />
	<link rel="stylesheet" href="__PUBLIC__css/layer.css" />
	<script type="text/javascript" src="__PUBLIC__js/jquery.min.js" ></script>
	<script type="text/javascript" src="__PUBLIC__js/jquery-ui.min.js" ></script>
	<script type="text/javascript" src="__PUBLIC__js/enajax.js" ></script>
	<script type="text/javascript" src="__PUBLIC__js/TouchSlide.1.1.js" ></script>
	<script type="text/javascript" src="__PUBLIC__js/questions.js" ></script>
	<script>
		var mql = window.matchMedia('(orientation: portrait)');
		function handleOrientationChange(mql) {
			if(mql.matches) {
			  console.log('portrait');  // 竖屏
			  $(".deTanImg").css({'left':'10%','right':'10%'});
			}else {
			  console.log('landscape'); // 横屏
			  $(".deTanImg").css({'left':'30%','right':'30%'});

			}
		}
		// 输出当前屏幕模式
		handleOrientationChange(mql);
		// 监听屏幕模式变化
		mql.addListener(handleOrientationChange);
	</script>
<style>
	#wrapper {top: 50px; bottom: 100px; left: 5px; right: 5px;}
	/*bottom*/
	.courseBtn{ position:fixed; left:0; bottom:0; text-align:center; height:40px; line-height:40px;/* padding:10px 0;*/ width:100%; background:-webkit-gradient(linear,center top,center bottom,from(rgba(211, 211, 211, 0)),to(rgba(216, 216, 216, 1)));}
	.courseBtn a{ display:block; color:#fff; font-size:21px; background-color:#00bdc7; margin:0 20%; border-radius:5px;}
	.courseBtn a i{ font-size:27px; vertical-align:text-bottom;}
	.courseBtn a.fenT {width: 50%; position: relative; float: left; margin: 0;/* background-color: #efefef; color: #666; */ border-radius:0; -webkit-border-radius: 0; font-size: 14px;}
	.courseBtn a.fenT:after { position: absolute; height: 100%; transform:scaleX(0.5); -webkit-transform: scaleX(0.5); width: 1px; background: #fff; top:0; right: 0; content: "";}
	.ddel2 {  position: fixed;  bottom: 0px;  z-index: 109;  left: 0px;  width: 100%;  height: 35px;/*  background: #159edc;*/background: #efefef; box-shadow: 2px 2px 2px 3px #ddd;}
	.ddel2 a { /* color: #fff; */ border-right: solid 1px #fff;color: #666; font-size: 14px;  width: 49%;  text-align: center;  cursor: pointer;/*  font-weight: bold;*/ line-height: 35px; text-align: center;}
	.ddel a.no, .ddel2 a.no {  color: #999;  cursor: text;}
	.ddel2 a.last {  float: left;  line-height: 35px; }
	.ddel2 a.next {  float: right;  line-height: 35px;}
	.ddel2 a:last-child {border: 0;}
	.ddel2.fen3 a {width: 33%;}
	.bottom {position: absolute; bottom: 0; left: 0; right: 0;}
	.bottom a.btn {margin: 0;}

	.common_animate:hover{ 
	    animation-duration:1s; /*动画时间*/
	   animation-fill-mode: both; /*播放后的状态*/
	    animation-name: buzz-out;
	    animation-iteration-count: infinite; /*动作循环的次数：infinite 无限循环*/
	    transform-origin: center bottom; /*设置动画旋转元素的基点为：居中靠下*/
	    cursor: pointer;
	}

    #tips {
        background-color:#333; 
        font-size: 14px; 
        display:none; 
        width: 90%; 
        left: 5%; 
        text-align: center; 
        color:#fff; 
        border-radius:5px; 
        opacity:.82; 
        padding:10px; 
        position:fixed; 
        top: calc(100% - 70px); 
        z-index: 999;
    }
    #tips img {vertical-align:middle; display: inline-block;}
    .right{background: #5adaaf;color: #fff; border: solid 1px #fff}
    .rightanswer{background: #5adaaf;color: #fff; border: solid 1px #fff}
    .error{background:#ff7272;color: #fff; border: solid 1px #fff;}
	/*.but{
		width: 50%;
		text-align: center;
		color: white;
		display: block;
		border-radius: inherit;
		background-color: #0d3046;
        opacity: 0.8;
		line-height: 40px;
		float: left;
	}*/

    .but{
        display: block;
        position:relative;
        text-align: center;
        color:#fff;
        width:50%;
        float:left;
        border-radius:10px;
        border-bottom: 1px solid rgba(255,255,255,0.3);
        text-shadow: 1px 1px 5px #333;
        height:45px;
        line-height: 45px;
        background: -webkit-linear-gradient(#5a8e9b,#397da2); /* Safari 5.1 - 6.0 */
        background: -o-linear-gradient(#5a8e9b,#397da2); /* Opera 11.1 - 12.0 */
        background: -moz-linear-gradient(#5a8e9b,#397da2); /* Firefox 3.6 - 15 */
        background: linear-gradient(#558b9d,#397da2); /* 标准的语法 */
        box-shadow: 1px 1px 3px #04283f;
        margin-bottom:5px;
    }

    /*.spellbut{
        width: 100%;
        text-align: center;
        color: white;
        display: block;
        border-radius: inherit;
        background-color: #0d3046;
        opacity: 0.8;
        line-height: 40px;
        float: left;
    }*/
    .spellbut{
        display: block;
        margin-bottom: 5px;
        color: #fff;
        position:relative;
        text-align: center;
        border-radius:10px;
        border-bottom: 1px solid rgba(255,255,255,0.3);
        text-shadow: 1px 1px 5px #333;
        height:45px; line-height: 45px ;
        background: -webkit-linear-gradient(#5a8e9b,#397da2); /* Safari 5.1 - 6.0 */
        background: -o-linear-gradient(#5a8e9b,#397da2); /* Opera 11.1 - 12.0 */
        background: -moz-linear-gradient(#5a8e9b,#397da2); /* Firefox 3.6 - 15 */
        background: linear-gradient(#5a8e9b,#397da2); /* 标准的语法 */
        box-shadow: 1px 1px 3px #04283f;
    }

    .bg {
        content: "";
        display: block;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 19;
        background: #000;
        opacity: 0.5;
        position: fixed;
    }
    .bg:after {
        position: fixed;
        content: "";
        width: 100%;
        height: 100%;
        display: block;
        background: rgba(0,0,0,0.2);
        top: 0;
    }

    .deTanImg {
        position: fixed;
        top: 10%;
        left: 10%;
        right: 10%;
        z-index: 98;
        text-align: center;
    }

    .ktBtn {
        display: inline-block;
        background: #fff;
        color: #666;
        width: 120px;
        border-radius: 10px;
        line-height: 40px;
        height: 40px;
        text-align: center;
        margin: 20px 5px;
        box-shadow: 1px 5px 0px #C0C0C0;
    }

    .ktBtn.kyello {
        background: #ff6823;
        color: #fff;
        box-shadow: 1px 5px #333;
    }
    

    .ktBtn.kgreen {
        background: #32b16c;
        color: #fff;
        box-shadow: 1px 5px #333;
    }

    .tancH2 {
        position: absolute;
        top: 0;
        color: orangered;
        text-align: center;
        width: 80%;
        left: 10%;
        padding-top: 70%;
    }

    .deTanImg .close {
        position: absolute;
        bottom: -60px;
        color: #Fff;
        left: 45%;
        font-size: 2em;
    }
	 
	@-webkit-keyframes buzz-out {
	  0%,
	  100%,
	  20%,
	  50%,
	  80% {
	  transition-timing-function: cubic-bezier(0.215,0.61,0.355,1); /*贝塞尔曲线 ： X1 Y1 X2 Y2*/
	  transform: translate3d(0,0,0); /*设置只在Z轴上移动*/
	  }
	  40%,
	  43%{
	  transition-timing-function: cubic-bezier(0.755,0.50,0.855,0.060);
	  transform: translate3d(0,-30px,0);
	  }
	  70%{
	  transition-timing-function: cubic-bezier(0.755,0.050,0.855,0.060);
	  transform: translate3d(0,-15px,0);
	  }
	  90%{
	  transform: translate3d(0,-4px,0);
	  }
	}	
</style>
</head>
<body class="bbBlueq">
	<section>
		<div class="wrap">
		   <span id="animationSandbox" style="color: #fff;z-index:11; display:block; position: absolute; top: 30%; left: 20%;" class="animated zoomOutUp">
		   <i class="tup-huojian"></i>
		   </span>
		    <span id="animationSandbox" style="display: block; background: #205663; color: #fff; width: 30%; text-align: center; height: 2em; line-height: 2em; top: 40%; left: 35%; z-index: 9; position: absolute;"  class="animated rotateOutDownLeft">
		      {$name}
		    </span>
		 </div>
	</section>
	<section id="dati"  style="display:none;">
		<header>
			<div class="table">
				<div class="pad10-0 w100" id="guan">
					<a class="guan"><i class="icon-cuo02"></i></a>
				</div>
				<div class="pad10">
					<div class="jinduBar">
						<span style="width: {$pregress}%;" id="progress"></span>
						<em id="cur"><font id="curindex">1</font>/<font id="count">{$quescount}</font><!-- <a href="javascript:window.location.reload();">刷新</a> --></em>
					</div>
				</div>
				<div class="pad10-0 w100 topZan">
					<a class="" id="times">{$errnum}</a>
					<i class="icon-zan"></i>
				</div>
			</div>
		</header>
		<!--试题内容-->
		<div class="bd" id="iScroll-bd">
	        
		</div>
	</section><!--end 答题部分-->
	<div id="tips"></div>
    <div class="SWtan" id="tan02" style="display:none;">
        <h2 class="textH3">剩余失误次数</h2>
    </div>
    <!--遮罩的代码-->
    <div id="over" class="over"></div>
    <div id="layout" class="layout">
        <img src="__SUBJECT__img/2013112931.gif" alt="" />
    </div>
    <style>
        .over {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f5f5f5;
            opacity:0.5;
            z-index: 1000;
        }
        .layout {
            display: block;
            position: absolute;
            top: 40%;
            left: 40%;
            width: 20%;
            height: 20%;
            z-index: 1001;
            text-align:center;
        }
        .cur{
            background-color: oldlace;
        }
        body{background:#fff}
    </style>
	</body>
	<script type="text/javascript" src="__SUBJECT__js/wordgame.js" ></script>
	<script type="text/javascript" src="__SUBJECT__game/js/layer.js" ></script>
	<script type="text/javascript">
	    var subjectsource="__SUBJECT__";
	    var questionskeys=[];
	    var questionslist=0;
	    var curindex=0;
	    var levelid="{$levelid}";
        var nextexitst="{$nextexitst}";
        var gameid="{$gameid}";
        var index="{$index}";
        var page=0;
        //弹窗函数
        //
        // <section id="jieS" style="display:none;">
        //     <!--<div class="tupTan"></div>-->
        //     <div class="tupT radius8 pad10 posR">
        //         <a class="icc-close01"><i class="icon-cuo04"></i></a>
        //         <a class="icc-xing1"></a>
        //         <div class="radius8 nrDian">
        //             <p class="Tcenter">闯关成功</p>
        //             <div class="Tjifen"><a class="icc-xin"></a>星星 X 3</div>
        //             <div class="pad10"><a class="btn-ff">错题本</a><a class="btn-ff zd fr ">下一关</a></div>
        //         </div>
        //     </div>
        // </section>
        var dialog=function(a){
            a = a || {};
            var options = {
                suc:a.suc,
                obj:a.obj,
                title: a.title,
                content: a.content,
                contentimg:a.contentimg,
                yescontent: a.yescontent,
                yesfunc: a.yesfunc,
                nocontent:a.nocontent,
                nofunc:a.nofunc
            };
            var section=$('<div class="bg" id="bg1"></div>');
            $(options.obj).append(section);
            var div=$('<div class="deTanImg" id="over"></div>');
            if($(window).width()>$(window).height()){
            	$(div).css({'left':'30%','right':'30%'});
            }else{
            	$(div).css({'left':'10%','right':'10%'});
            }
            $(options.obj).append(div);
            var divv=$('<div class="posR"></div>')
            div.append(divv);
            var img=$('<img src="'+a.contentimg+'" class="img100"/>');
            divv.append(img);
            var h2=$('<h2 class="tancH2">'+options.content+'</h2>');
            divv.append(h2);
            //var a=$('再学一遍</a>');
            var qa=$('<a class="ktBtn kyello"></a>');
            qa.text(options.yescontent);
            qa.bind('click',function(){
                options.yesfunc();           
            });
            div.append(qa);
            var ca=$('<a class="ktBtn kgreen"></a>');
            ca.bind('click',function(){
                options.nofunc();
            });
            ca.text(options.nocontent);
            div.append(ca);
            // var span=$('<span class="close"><i class="icon-error03"></i></span>');
            // div.append(span);
            // span.bind("click",function(){
            //     $("#over").remove();
            //     $("#over").remove();
            //     $('#bg1').remove();
            //     $('#bg1').remove();
            // });
        };
        //初始化问题
        var questionobj=new Question({
	        isAuto: 1,
	        errorUrl:"../Api/setErrorLogApi",
	        answerUrl:"setUserGameAnswer",
	        audioPlay:function(audio){
	            try{
	                UXinJSInterfaceSpeech.playAudio(audio);
	            }catch(e){
	                setTip("请升级到最新的优教信使");
	            }
	        },
	        imgBlank:"__PUBLIC__public/images/404.jpg",
	        rightCallBack:function(){
                //获取数值
                var curindex=parseInt($("#curindex").text());
                var count=parseInt($("#count").text());
                var overplus=parseInt($("#times").text());
                var score=count-(Math.round(0.25*count)-overplus);

                if(curindex==count){
                    setTimeout(function(){
                        var gameid=Requests["gameid"];
                        var index=Requests["index"];
                        var nextcontent=(nextexitst=='1'?"下一关":"完成");
                        var nexturl=(nextexitst=='1'?'game?gameid='+gameid+'&index='+(parseInt(index)+1)+"&backUrl="+Requests["backUrl"]:'gamelevel?id='+gameid+"&backUrl="+Requests["backUrl"]);
                        $.ajax({url:"setUserGameLevelOver",async:true,type:'post',data:{request:JSON.stringify(Requests),donum:count,isover:"1",issuc:'1',rightnum:score,ran:Math.random()}});
                        dialog({
                            suc:1,
                            obj:"section",
                            title:"闯关成功",
                            content:"获得星星+"+score,
                            contentimg:"__SUBJECT__/images/guo02.png",
                            nocontent:"排行榜",
                            nofunc:function(){
                                var gameid=Requests["gameid"];
                                var index=Requests["index"];
                                window.location.href="classrank?gameid="+gameid+"&backUrl="+Requests["backUrl"];
                            },
                            yescontent:nextcontent,
                            yesfunc:function(){
                                window.location.href=nexturl;
                            }
                        });
                    },1000);
                }else{
                    //正确的弹窗
                    setTimeout(function(){
                        var curindex=parseInt($("#curindex").text());
                        $("#curindex").text(curindex+1);
                        var count=parseInt($("#count").text());
                        var pregress=Math.round(((curindex+1)/count)*100);;
                        $("#progress").attr("style","width:"+pregress+"%;");
                        $("#iScroll-bd").empty();
                        var key=questionskeys[curindex];
                        var value=questionslist[questionskeys[curindex]];
                        var questype=value.questype;
                        var tntype=0;
                        var itemtype="single";
                        if(questype=='6'){
                            tntype=4;
                            itemtype="spell";
                        }else if(questype=='0'||questype=='1'){
                            tntype=2;
                        }else if(questype=='3'){
                            tntype=3;
                        }
                        var itemviewtype=value.items[0].typeid;
                        console.log(questionobj); 
                        var question=questionobj.setQuestion(0,tntype,itemtype,itemviewtype,key,value);
                        $("#iScroll-bd").append(question);
                    },1000);
                }
                try{$(".spellbut").remove();}catch(e){};
	        },
	        errorCallBack:function(obj,i){

	        	//当前数量自己总数量
	        	var curindex=parseInt($("#curindex").text());
                var count=parseInt($("#count").text());
                //主要是问题的属性
                var questionid=$(obj).attr("questionid");
                var wordid=$(obj).attr("wordid");
                var explainid=$(obj).attr("explainid");
                //修改目前的样式
                $("#times").text(parseInt($("#times").text())-i);
                //剩余数量
                var overplus=parseInt($("#times").text());
                var score=curindex-(Math.round(0.25*count)-overplus);
                //出现下面按钮
                var nav=$('<div style="position:fixed;z-index:0;left: 0;bottom: 0;width:100%;"></div>');
                $(obj).parents(".overY").append(nav);
                //判断有没有解析
                var isanalysis=$(obj).parents(".con").attr("isanalysis");
                //添加左边的按钮
                var wa=$('<a class="wordlearn but" questionid="'+questionid+' wordid='+wordid+' explainid='+explainid+' href="javascript:void(0);"></a>');

                nav.append(wa);
                var url="";
                if(isanalysis=='0'){
                    //没有解析的情况
                    wa.text("单词学习");
                    url=window.location.protocol+"//"+window.document.domain+'/Subject/Game/wordlearn?questionid='+questionid+'&wordid='+wordid+"&explainid="+explainid;
                }else{
                    //有解析的情况
                    wa.text("试题解析");
                    url=window.location.protocol+"//"+window.document.domain+'/Subject/Game/analysis?questionid='+questionid+"&wordid="+wordid+"&explainid="+explainid+"&gameid="+Requests["gameid"]+"&index="+Requests["index"];
                }
                wa.bind('click',function(){
                    //显示遮罩并且使用layer弹窗
                    UXinJSInterface.openProgressController(url);
                });
                //添加右边的按钮
                var na=$('<a class="next but" href="javascript:void(0);"></a></div>');
                nav.append(na);
                if(curindex==count){
                    na.text("完成");
                    var issuc=0;
                    var plus=parseInt($("#times").text());
                    if(plus==0){
                        issuc=0;
                    }else{
                        issuc=1;
                    }
                    $.ajax({url:"setUserGameLevelOver",async:true,type:'post',data:{request:JSON.stringify(Requests),donum:curindex,isover:"1",issuc:issuc,rightnum:score,ran:Math.random()}});
                    na.bind('click',function(){
                        //进行下一题的展示
                        var overplus=parseInt($("#times").text());
                        var count=parseInt($("#count").text());
                        //判断是够成功
                        if(overplus==0){
                            //表示闯关失败
                            dialog({
                                suc:0,
                                obj:"section",
                                title:"闯关失败",
                                content:"",
                                contentimg:"__SUBJECT__/images/shibai.png",
                                nocontent:"退出",
                                nofunc:function(){
                                    var gameid=Requests["gameid"];
                                    var index=Requests["index"];
                                    window.location.href="gamelevel?id="+gameid+"&backUrl="+Requests["backUrl"];
                                },
                                yescontent:"重新闯关",
                                yesfunc:function(){
                                    window.location.reload();
                                }
                            });
                        }else{
                            var gameid=Requests["gameid"];
                            var index=Requests["index"];
                            var nextcontent=(nextexitst=='1'?"下一关":"完成");
                            var nexturl=(nextexitst=='1'?'game?gameid='+gameid+'&index='+(parseInt(index)+1)+"&backUrl="+Requests["backUrl"]:'gamelevel?id='+gameid+"&backUrl="+Requests["backUrl"]);
                            dialog({
                                suc:1,
                                obj:"section",
                                title:"闯关成功",
                                content:"获得星星+"+score,
                                contentimg:"__SUBJECT__/images/guo02.png",
                                nocontent:"排行榜",
                                nofunc:function(){
                                    var gameid=Requests["gameid"];
                                    var index=Requests["index"];
                                    window.location.href="classrank?gameid="+gameid+"&backUrl="+Requests["backUrl"];
                                },
                                yescontent:nextcontent,
                                yesfunc:function(){
                                    window.location.href=nexturl;
                                }
                            });

                        }
                    })
                }else{
                    if(overplus==0){
                        $.ajax({url:"setUserGameLevelOver",async:true,type:'post',data:{request:JSON.stringify(Requests),donum:curindex,isover:"1",rightnum:score,issuc:'0',ran:Math.random()}});
                        na.text("完成");
                        na.bind('click',function(){
                            dialog({
                                suc:0,
                                obj:"section",
                                title:"闯关失败",
                                content:"",
                                contentimg:"__SUBJECT__/images/shibai.png",
                                nocontent:"退出",
                                nofunc:function(){
                                    var gameid=Requests["gameid"];
                                    var index=Requests["index"];
                                    window.location.href="gamelevel?id="+gameid+"&backUrl="+Requests["backUrl"];
                                },
                                yescontent:"重新闯关",
                                yesfunc:function(){
                                    window.location.reload();
                                }
                            });
                        });
                    }else{
                        na.text("下一题");
                        na.bind('click',function(){
                            $("#curindex").text(curindex+1);
                            var count=parseInt($("#count").text());
                            var pregress=Math.round(((curindex+1)/count)*100);
                            $("#progress").attr("style","width:"+pregress+"%;");
                            $("#iScroll-bd").empty();
                            var key=questionskeys[curindex];
                            var value=questionslist[questionskeys[curindex]];
                            var questype=value.questype;
                            var tntype=0;
                            var itemtype="single";
                            if(questype=='6'){
                                tntype=4;
                                itemtype="spell";
                            }else if(questype=='0'||questype=='1'){
                                tntype=2;
                            }else if(questype=='3'){
                                tntype=3;
                            }
                            var itemviewtype=value.items[0].typeid;
                            console.log(questionobj); 
                            var question=questionobj.setQuestion(0,tntype,itemtype,itemviewtype,key,value);
                            $("#iScroll-bd").append(question);
                        });
                    }
                }
                $(window).resize();
                try{$(".spellbut").remove();}catch(e){};
                $.ajax({url:"setUserGameWordBook",async:true,type:'post',data:{request:JSON.stringify(Requests),questionid:questionid,ran:Math.random()}});
	        }
	    });
        $(function(){
            //进行问题的初始化
            $.ajax({url:"gameadduserinfo",async:true,type:'post',data:{gameid:gameid,index:index,ran:Math.random()}});
            getGameQuestionsList("getQuestionListByLevelid",levelid,$("#iScroll-bd"));
            perface();
			//退出关闭
			$("#guan").click(function(){
                var curindex=parseInt($("#curindex").text());
                var count=parseInt($("#count").text());
                //剩余数量
                var overplus=parseInt($("#times").text());
                var score=curindex-(Math.round(0.25*count)-overplus);
				//$.ajax({url:"setUserGameLevelOver",async:true,type:'post',data:{issuc:"0",request:JSON.stringify(Requests),isover:'0',ran:Math.random()}});
				dialog({
                    suc:0,
                    obj:"section",
                    title:"退出测试",
                    content:"",
                    contentimg:"__SUBJECT__images/SignOut.png",
                    nocontent:"取消",
                    nofunc:function(){
                        $("#over").remove();
                        $("#over").remove();
                        $('#bg1').remove();
                        $('#bg1').remove();
                    },
                    yescontent:"退出",
                    yesfunc:function(){
                        var gameid=Requests["gameid"];
                        var index=Requests["index"];
                        window.location.href='gamelevel?id='+gameid+"&backUrl="+Requests["backUrl"];
                    }
                });
			})

             $('.topZan').click(function(e){
                $('#tan02').slideToggle();
             });
	    });

	</script>
</html>
                